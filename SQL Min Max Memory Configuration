

USE [master];
GO

IF EXISTS
(
	SELECT *
	FROM sys.objects
	WHERE object_id = OBJECT_ID(N'[dbo].[spMemoryConfig]') AND 
		  type IN( N'P', N'PC' )
)
BEGIN
	DROP PROCEDURE [dbo].[spMemoryConfig];
END;
GO

SET ANSI_NULLS ON;
GO

SET QUOTED_IDENTIFIER ON;
GO

IF NOT EXISTS
(
	SELECT *
	FROM sys.objects
	WHERE object_id = OBJECT_ID(N'[dbo].[spMemoryConfig]') AND 
		  type IN( N'P', N'PC' )
)
BEGIN
	EXEC dbo.sp_executesql @statement = N'CREATE PROCEDURE [dbo].[spMemoryConfig] AS';
END;
GO

ALTER PROCEDURE [dbo].[spMemoryConfig]
( 
				@InstanceCount int= 1, @MinMemoryPCT int= 30, @PrintOnly BIT= 1
)
AS
BEGIN
	DECLARE @max_memory int, @min_memory int, @os_memory int, @total_memory int;
	IF
(
	SELECT total_physical_memory_kb / 1024
	FROM sys.dm_os_sys_memory
) <= 8192
	BEGIN
		SET @os_memory = 2048;
	END;
	ELSE
	BEGIN
		IF
(
	SELECT total_physical_memory_kb / 1024
	FROM sys.dm_os_sys_memory
) <= 32768
		BEGIN
			SET @os_memory = 4096;
		END;
		ELSE
		BEGIN
			IF
(
	SELECT total_physical_memory_kb / 1024
	FROM sys.dm_os_sys_memory
) <= 65536
			BEGIN
				SET @os_memory = 8192;
			END;
			ELSE
			BEGIN
				SET @os_memory = 12288;
			END;
		END;
	END;
	SET @max_memory = (
(
	SELECT total_physical_memory_kb / 1024
	FROM sys.dm_os_sys_memory
) - @os_memory ) / @InstanceCount;
	SET @min_memory = 0.3 * @max_memory;
	SELECT @total_memory = CONVERT(varchar(8), total_physical_memory_kb / 1024)
	FROM sys.dm_os_sys_memory;
	PRINT '--Total Server Memory: '+CONVERT(varchar(8), @total_memory)+' MB';
	PRINT '--Max SQL Memory: '+CONVERT(varchar(8), @max_memory)+' MB';
	PRINT '--Min SQL Memory: '+CONVERT(varchar(8), @min_memory)+' MB';
	PRINT '--OS Memory: '+CONVERT(varchar(8), @os_memory)+' MB';
	IF(@PrintOnly = 0)
	BEGIN
		IF
(
	SELECT value_in_use
	FROM sys.configurations
	WHERE NAME LIKE 'min server memory (MB)'
) <> @min_memory
		BEGIN
			EXEC sys.sp_configure N'min server memory (MB)', @min_memory;
			RECONFIGURE WITH OVERRIDE;
		END;
		IF
(
	SELECT value_in_use
	FROM sys.configurations
	WHERE NAME LIKE 'max server memory (MB)'
) <> @max_memory
		BEGIN
			EXEC sys.sp_configure N'max server memory (MB)', @max_memory;
			RECONFIGURE WITH OVERRIDE;
		END;
	END;
END;
GO
