DECLARE @command NVARCHAR(MAX);
DECLARE @name SYSNAME;
DECLARE @filename NVARCHAR(MAX);
DECLARE db_cursor CURSOR
FOR SELECT name
    FROM sys.databases
    WHERE create_date > DATEADD(dd, -1, GETDATE());
OPEN db_cursor;
FETCH NEXT FROM db_cursor INTO @name;
WHILE @@FETCH_STATUS = 0
    BEGIN
        DECLARE filenames CURSOR
        FOR SELECT name
            FROM sys.master_files
            WHERE database_id = DB_ID(@name)
                  AND size < (256 * 128);
        OPEN filenames;
        FETCH NEXT FROM filenames INTO @filename;
        WHILE @@FETCH_STATUS = 0
            BEGIN
                SET @command = 'ALTER DATABASE ['+@name+'] MODIFY FILE ( NAME = N'''+@filename+''', SIZE = 256MB , FILEGROWTH = 128MB )';
                PRINT @command;
                EXEC sp_executesql
                     @command;
                FETCH NEXT FROM filenames INTO @filename;
            END;
        SET @command = 'ALTER AUTHORIZATION ON DATABASE ::['+@name+'] TO [sa];';
        PRINT @command;
        EXEC sp_executesql
             @command;
        ALTER DATABASE [Hi] SET PAGE_VERIFY CHECKSUM WITH NO_WAIT;
        SET @command = 'ALTER DATABASE ['+@name+'] SET RECOVERY FULL WITH NO_WAIT;';
        PRINT @command;
        EXEC sp_executesql
             @command;
        SET @command = 'ALTER DATABASE ['+@name+'] SET PAGE_VERIFY CHECKSUM  WITH NO_WAIT;';
        PRINT @command;
        EXEC sp_executesql
             @command;
        SELECT @command = 'ALTER DATABASE ['+@name+'] SET COMPATIBILITY_LEVEL = '+CONVERT(VARCHAR(3), compatibility_level)+';'
        FROM sys.databases
        WHERE name = 'master';
        PRINT @command;
        EXEC sp_executesql
             @command;
        SET @command = N'USE '+@name+'; DECLARE @userid VARCHAR(255);
CREATE TABLE #OrphanUsers
(UserName VARCHAR(100),
 USID     NVARCHAR(255)
);
INSERT INTO #OrphanUsers
EXEC sp_change_users_login
     ''report'';
DECLARE FixUser CURSOR
FOR SELECT UserName
    FROM #OrphanUsers;
OPEN FixUser;
FETCH NEXT FROM FixUser INTO @userid;
WHILE @@FETCH_STATUS = 0
    BEGIN TRY
        EXEC sp_change_users_login
             ''update_one'',
             @userid,
             @userid;
        PRINT ''--User ''+@userid+'' is mapped;'';
        FETCH NEXT FROM FixUser INTO @userid;
    END TRY
    BEGIN CATCH
        PRINT ''DROP user ''+@userid+'';'';
        FETCH NEXT FROM FixUser INTO @userid;
    END CATCH;
CLOSE FixUser;
DEALLOCATE FixUser;
DROP TABLE #OrphanUsers;';
        EXEC sp_executesql
             @command;
        CLOSE filenames;
        DEALLOCATE filenames;
        FETCH NEXT FROM db_cursor INTO @name;
    END;
CLOSE db_cursor;
DEALLOCATE db_cursor;
